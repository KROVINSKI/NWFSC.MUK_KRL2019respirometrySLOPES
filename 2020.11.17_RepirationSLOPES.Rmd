---
title: "Respirometry Trails and Slope Creation for Summer Krill 2019"
output:
 html_document:
    df_print: paged
    code_folding: hide
    toc: TRUE
    toc_depth: 4
    toc_float: true
    theme: journal
    highlight: zenburn
    smart: false

---


Hello World

Author: OA Lab, NWFSC
Title: Respirometry Trails for Summer Krill 2019
Date: November 2020

#Respirometry Trails and Slope Creation for Summer Krill 2019
```{r 0.1 Version Check , echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#*********************************
## Version Check
#********************************* 
R.version

```



```{r 0.0 Libraries , echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
#*********************************
##Libraries
#********************************* 
library(stringr)
library(tidyverse)
library(plyr)
library(nlme)
library(tidyr)
library(purrr)
library(wql)
library(lubridate)
library(arsenal)
library(compareDF)
#for graphing
library(ggplot2)
library(stringr)
library(nlme)
library(RColorBrewer)
#statistical analysis
library(gdata)
library(rsq)
library(doBy)
#Rnotebooks 
library(gridExtra)
library(kableExtra)

```


 
# 1.) Setting Working Directory
```{r 1.) Setting Working Directory }
#*********************************
## 1.) Setting Working Directory
#*********************************

#set working directory to the correct folder
setwd("/Users/katherinerovinski/GIT/NWFSC.MUK_KRL2019respirometrySLOPES")
```



# 2.) Creating the Dataframe
```{r 2.) Creating the Dataframe }

#*********************************
## 2.) Creating the intial Dataframe, dtotal
#*********************************

##PRESENSE observations grouped by Krill ID
dtotal <- read.csv(file = "2020.11.16_GRP_dtotalObservations.csv", stringsAsFactors = FALSE)
dim(dtotal)

dtotal <- dtotal %>% filter(!MOATS %in% c("3", "4", "5", "11")) %>%
  filter(Treatment %in% c("CUR", "CHG", "TMP")) 


```



# 3.) Cleaning up observations
```{r 3.) Cleaning up observations }
#*********************************
## 3.) Cleaning up observations  
#********************************

#Removing items with faulty sensor names
dtotal <- subset(dtotal, KrillID != "")

unique(dtotal$KrillID)

```



# 4.) DO Plot Check
```{r 4.) DO Plot Check  }
#*********************************
## 4.) DO Plot Check  
#*********************************

ggplot(dtotal, aes(x = Time, y = actualDOmg, colour = KrillID)) +
  geom_point(size = 1) +
  geom_smooth(method = "lm") +
  facet_wrap(~TrialID.x) +
  #scale_y_continuous(breaks=seq(250,950,by=50))   +
  theme_bw()

```


# 5.) Plotting Percent DO by Trial (80%)
## 5.1) PLotting Percent DO filtering Trial 1
```{r 5.1) PLotting Percent DO filtering Trial 1}

Trial1percentDO <- filter(dtotal, TrialID.x == "Trial01")


ggplot(Trial1percentDO, aes(x = Time, y = percentDO, colour = SensorName)) +
  geom_point(size = 1) +
  geom_smooth(method = "lm") +
  #scale_y_continuous(breaks=seq(250,950,by=50))   +
  ggtitle("Trial01 Percent DO") +
  facet_wrap(~ Treatment) + 
  geom_hline(yintercept = c(.8), colour = "red") +
  theme_bw()


```


## 5.2) PLotting Percent DO filtering Trial 2
```{r 5.2) PLotting Percent DO filtering Trial 2}

Trial2percentDO <- filter(dtotal, TrialID.x == "Trial02")


ggplot(Trial2percentDO, aes(x = Time, y = percentDO, colour = SensorName)) +
  geom_point(size = 1) +
  geom_smooth(method = "lm") +
  #scale_y_continuous(breaks=seq(250,950,by=50))   +
  ggtitle("Trial02 Percent DO") +
  facet_wrap(~ Treatment) + 
   geom_hline(yintercept = c(.8), colour = "red") +
  theme_bw()


```


## 5.3) PLotting Percent DO filtering Trial 3
```{r 5.3) PLotting Percent DO filtering Trial 3}

Trial3percentDO <- filter(dtotal, TrialID.x == "Trial03")


ggplot(Trial3percentDO, aes(x = Time, y = percentDO, colour = SensorName)) +
  geom_point(size = 1) +
  geom_smooth(method = "lm") +
  #scale_y_continuous(breaks=seq(250,950,by=50))   +
  ggtitle("Trial03 Percent DO") +
  facet_wrap(~ Treatment) + 
   geom_hline(yintercept = c(.8), colour = "red") +
  theme_bw()


```


## 5.4) PLotting Percent DO filtering Trial 4
```{r 5.4) PLotting Percent DO filtering Trial 4}

Trial4percentDO <- filter(dtotal, TrialID.x == "Trial04")


ggplot(Trial4percentDO, aes(x = Time, y = percentDO, colour = SensorName)) +
  geom_point(size = 1) +
  geom_smooth(method = "lm") +
  #scale_y_continuous(breaks=seq(250,950,by=50))   +
  ggtitle("Trial04 Percent DO") +
  facet_wrap(~ Treatment) + 
   geom_hline(yintercept = c(.8), colour = "red") +
  theme_bw()


```

Notes to Self
apply the blanks within trial
don't comare blanks across trials
exhibit the blanks are showing a reduction in oxygen
any time that there is "evidence" of oxygen production place to zero
Need to determine background bacteria breathing our water investigation 



# 6.) Analysis, Respirometry - Creating the Slope Function 
```{r 6.) Analysis, Respirometry - Creating the Slope Function}
#*********************************
## 6.) Analysis, Respirometry - Creating the Slope Function  
#*********************************  
# legacy code

# vialVol <- 28.06 #ml
# 
# oxygen <- vialVol * dtotal$actualDOmg   
# 
# dRESPmsr$oxygen <- oxygen
# 
# #nmol/vial; conversion for L to ml and umol to nmol cancels
# 
# 
#slope funcion of 2 vectors
slope <- function(y,x){
  return(lm(y~x, na.action = na.omit)$coefficients[2])
}

# 
dtotal$delta_t <- as.numeric(dtotal$delta_t)
# 
# cSlopes <- by(dRESPmsr, dRESPmsr$KrillID, function(x){ slope(x$oxygen, x$delta_t)})
# 
# 
# #creating a data frame instead of a list 
# ds <- as.data.frame(sapply(cSlopes, I))
# #having row names be a variable in a column to be able to pull it out for later merging 
# ds$TrialID<- row.names(ds)

dtotal$KrillID <- factor(dtotal$KrillID)


info <- lmList(oxygen ~ delta_t|KrillID, dtotal,na.action=na.omit)

```






info <- lmList(oxygen ~ delta_t|KrillID, dtotal,na.action=na.omit)
#view(dtotal[!dtotal$KrillID %in% names(info), ])

```



##### 10.a Missing Slope Value
```{r 10.a Missing Slope Values}


MissingINFOobservations <- (dtotal[!dtotal$KrillID %in% names(info), ])
dtotalVSmissinfo <- summary(comparedf(dtotal, MissingINFOobservations))

kable(MissingINFOobservations)
```



##### 10.b Exploring 3 Missing Observations
```{r 10.a IncludedSlope Values}

write.csv(MissingINFOobservations, file = "2020.11.16_MissingINFOobservations.csv", row.names = FALSE)

#Summary function commented out due to errors below

summary(comparedf(dtotal, MissingINFOobservations, by = "delta_t"))
#Resulting Faults
#...Non-identical attributes
#...No non-identical attributes


# summary.comparedf(dtotal, MissingINFOobservations, by = delta_t)

#kable(Incld_UniqueKrillIDs)

```


## 10.x Comparison between Krillr4_58 and 59 to better determine differences
Using neighboring observations to determine if any difference
```{r 10.x Comparison between Krillr4_58 and 59 to better determine differences}

dRESP_58 <- read.csv(file = "2020.11.16_REPRwork_KRLr4_58comparison.csv", stringsAsFactors = FALSE)
dRESP_59 <- read.csv(file = "2020.11.16_REPRwork_KRLr4_59comparison.csv", stringsAsFactors = FALSE)

comparedf(dRESP_58, dRESP_59)

# Compare Object
# 
# Function Call: 
# comparedf(x = dRESP_58, y = dRESP_59)
# 
# Shared: 52 non-by variables and 41 observations.
# Not shared: 0 variables and 9 observations.
# 
# Differences found in 10/52 variables compared.
# 0 variables compared have non-identical attributes.


comparedf(dRESP_58, dRESP_59, by = "delta_t")


```



## 10.xx Comparing the slopes of 58 and 59 
```{r 10.xx Comparing the slopes of 58 and 59}

GRP_dtotal 
write.csv(GRP_dtotal, file = "2020.11.16_GRP_dtotalObservations.csv", row.names = FALSE)


GRP_dtotal_58 <- read.csv(file = "2020.11.16_GRP_dtotalObservationsKRL4_58.csv", stringsAsFactors = FALSE)
dtotal_58_filter <- filter(dtotal, KrillID == "Trial04_KRLr4_58")


GRP_dtotal_59 <- read.csv(file = "2020.11.16_GRP_dtotalObservationsKRL4_59.csv", stringsAsFactors = FALSE)
dtotal_59_filter <- filter(dtotal, KrillID == "Trial04_KRLr4_59")



GRP_dtotal_68 <- read.csv(file = "2020.11.16_GRP_dtotalObservationsKRL4_68.csv", stringsAsFactors = FALSE)
GRP_dtotal_69 <- read.csv(file = "2020.11.16_GRP_dtotalObservationsKRL4_69.csv", stringsAsFactors = FALSE)

# Krill58plot <-    ggplot(GRP_dtotal_58, 
#                 aes(x=Time, 
#                 y=oxygen))
# 
# Krill58plot


Krill58plot2 <- ggplot(GRP_dtotal_58, aes(delta_t, oxygen)) +
                geom_boxplot(notch = TRUE, outlier.shape = NA, colour = "green") +
                geom_point(data = GRP_dtotal_58, aes(x=delta_t, y=oxygen), size=5, color = "purple") + 
                ggtitle("Boxplot for Krill 58 observations") +
            theme_bw() 

Krill58plot2

# comparedf(dRESP_58, dRESP_59, by = "oxygen")

```

# 10.xxx T/S the linear model list function
```{r 10.xxx T/S the linear model list function }

# levels(dtotal$KrillID)
# 
# ##### Krill 58
# lm58 <- lm(oxygen ~ delta_t, GRP_dtotal_58, na.action=na.omit)
# info58 <- lmList(oxygen ~ delta_t|KrillID, GRP_dtotal_58, na.action=na.omit)
# GRP_dtotal_58$KrillID <- factor(GRP_dtotal_58$KrillID)
# levels(GRP_dtotal_58$KrillID)
# 
# 
# lm58f <- lm(oxygen ~ delta_t, dtotal_58_filter, na.action=na.omit)
# info58f <- lmList(oxygen ~ delta_t|KrillID, dtotal_58_filter, na.action=na.omit)
# 
# 
# info58 <- lmList(oxygen ~ delta_t|KrillID, GRP_dtotal_58, na.action=na.omit)
# GRP_dtotal_58$KrillID <- factor(GRP_dtotal_58$KrillID)
# levels(GRP_dtotal_58$KrillID)
# 
# 
# ### Krill 59
# 
# #using the filtered dtotal database rather than kate's copy and paste file
# lm59f <- lm(oxygen ~ delta_t, dtotal_59_filter, na.action=na.omit)
# info59f <- lmList(oxygen ~ delta_t|KrillID, dtotal_59_filter, na.action=na.omit)
# levels(dtotal_59_filter$KrillID)
# 
# 
# # working off of kate's copy paste file
# lm59 <- lm(oxygen ~ delta_t, GRP_dtotal_59, na.action=na.omit)
# info59 <- lmList(oxygen ~ delta_t|KrillID, GRP_dtotal_59, na.action=na.omit)
# 
# 
# #GRP_dtotal_59 <- subset(GRP_dtotal_59, KrillID != "")
# GRP_dtotal_59a <- filter(GRP_dtotal_59, KrillID = "")
# 
# 
# GRP_dtotal_59$KrillID <- factor(GRP_dtotal_59$KrillID)
# levels(GRP_dtotal_59$KrillID)
# 
# 
# 
# ### hunting for missing values
# dtotal59fmissingOXY <- filter(dtotal_59_filter, is.na(oxygen))
# dotal59fmissingDELT <- filter(dtotal_59_filter, is.na(delta_t))
# # no missing values found 

write.csv(dtotal, file = "2020.11.16_dtotal_TSlinearmodel.csv", row.names = FALSE)


```

## 10.xxxx Creating a small box plot for Krill 59
```{r 10.xxxxx Creating a small box plot for Krill 59}

Krill59plot <- ggplot(GRP_dtotal_59, aes(delta_t, oxygen)) +
                geom_boxplot(notch = TRUE, outlier.shape = NA, colour = "green") +
                geom_point(data = GRP_dtotal_59, aes(x=delta_t, y=oxygen), size=5, color = "purple") + 
                ggtitle("Boxplot for Krill 59 observations") +
            theme_bw() 

Krill59plot

```


## 10.xxxxxxx Creating a small box plot for Krill 68
```{r 10.xxxxxxx Creating a small box plot for Krill 68}

Krill68plot <- ggplot(GRP_dtotal_68, aes(delta_t, oxygen)) +
                geom_boxplot(notch = TRUE, outlier.shape = NA, colour = "green") +
                geom_point(data = GRP_dtotal_68, aes(x=delta_t, y=oxygen), size=5, color = "purple") + 
                ggtitle("Boxplot for Krill 58 observations") +
            theme_bw() 

Krill68plot

```



## 10.xxxxxxx Creating a small box plot for Krill 69
```{r 10.xxxxxx Creating a small box plot for Krill 69}

Krill69plot <- ggplot(GRP_dtotal_69, aes(delta_t, oxygen)) +
                geom_boxplot(notch = TRUE, outlier.shape = NA, colour = "green") +
                geom_point(data = GRP_dtotal_69, aes(x=delta_t, y=oxygen), size=5, color = "purple") + 
                ggtitle("Boxplot for Krill 58 observations") +
            theme_bw() 

Krill69plot

```


#11.) Creating the linear Model on the Slope (Sapply) 
```{r 10.) Creating the linear Model on the Slope (Sapply) }

info <- lmList(oxygen ~ delta_t|KrillID, dtotal,na.action=na.omit)



```


##12.) Trouble Shooting the Linear Model Problems
```{r}

# summary(lm(oxygen ~ delta_t, data= dtotal[dtotal$KrillID=="Trial04_KRLr4_59",]))$r.squared
# 
# lm(oxygen ~ delta_t, data= dtotal[dtotal$KrillID=="Trial04_KRLr4_68",])
# 
# lm(oxygen ~ delta_t, data= dtotal[dtotal$KrillID=="Trial04_KRLr4_69",])
# 
# 
# dtotal[is.na(dtotal$delta_t),]
# unique(dtotal$KrillID)
# 
# names(info)
# 
# view(dtotal[!dtotal$KrillID %in% names(info), ])
# 
# 
# print(info)
# 
# # slopes <- coef(info)[2]
# # #print(slopes)
# # dslopes <- data.matrix(slopes)
# # #View(dref)
# # mode(dslopes[,1])
# # dslopes <- as.data.frame(dslopes)
# # dslopes$slope <- dslopes$delta_t
# # dslopes$delta_t <- NULL
# # #View(dslopes)
# 
# #now for R^2!!
# Rsq <- sapply(info,function(x) summary(x)$r.squared)
# t(Rsq) #transposes rows and columns
# Rsq <- data.matrix(Rsq)
# #View(Rsq)
# dtotal <- cbind(ds, Rsq)
# View(dtotal)
```









```{r}
#**************E*N*D*************# 
#*********************************
## END OF SCRIPT | END OF DOCUMENT 
#*********************************
```


## END OF SCRIPT | END OF DOCUMENT